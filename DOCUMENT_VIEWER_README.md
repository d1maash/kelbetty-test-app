# Новая система просмотра и редактирования документов KelBetty

## Обзор изменений

Мы полностью переработали систему просмотра и редактирования документов, чтобы сохранять оригинальный формат и стиль загруженных файлов. Теперь каждый тип документа отображается в своем родном формате с возможностью редактирования без потери форматирования.

## Новые компоненты

### 1. UniversalDocumentViewer
Универсальный просмотрщик документов, который автоматически определяет тип файла и использует соответствующий компонент для отображения.

**Особенности:**
- Автоматическое определение типа документа
- Переключение между режимами просмотра (оригинал, форматированный, текст)
- Полноэкранный режим
- Поворот документа
- Интеграция с AI чатом

### 2. PDFViewer
Специализированный просмотрщик для PDF документов с использованием `react-pdf`.

**Возможности:**
- Навигация по страницам
- Масштабирование (50% - 300%)
- Поворот документа
- Поддержка аннотаций и текстового слоя
- Полноэкранный режим

### 3. WordViewer
Просмотрщик для Word документов (.doc, .docx) с использованием `docx-preview`.

**Возможности:**
- Отображение с сохранением оригинального форматирования
- Навигация по страницам
- Масштабирование
- Поддержка таблиц, изображений и стилей

### 4. ExcelViewer
Просмотрщик для Excel файлов (.xls, .xlsx) с использованием `xlsx`.

**Возможности:**
- Переключение между листами
- Отображение данных в табличном формате
- Экспорт в CSV
- Масштабирование
- Поддержка больших таблиц

### 5. PowerPointViewer
Просмотрщик для PowerPoint презентаций (.ppt, .pptx).

**Возможности:**
- Навигация по слайдам
- Автопрокрутка
- Масштабирование
- Отображение содержимого слайдов

### 6. FormatPreservingEditor
Новый редактор документов, который сохраняет оригинальное форматирование с использованием Monaco Editor.

**Возможности:**
- Поддержка различных языков программирования
- Поиск и замена текста
- Отмена/повтор действий
- Горячие клавиши (Ctrl+S, Ctrl+F)
- Автодополнение и подсветка синтаксиса
- Сохранение в оригинальном формате

## Установленные зависимости

```bash
npm install react-pdf @monaco-editor/react office-viewer mammoth docx-preview
```

## Использование

### Замена старых компонентов

**Было:**
```tsx
import { RichEditor } from '@/components/document/rich-editor'
import { FormattedDocumentViewer } from '@/components/document/formatted-document-viewer'

// В компоненте
<RichEditor
    initialContent={content}
    onContentChange={handleChange}
    onSave={handleSave}
/>

<FormattedDocumentViewer
    document={document}
    onEdit={handleEdit}
/>
```

**Стало:**
```tsx
import { FormatPreservingEditor } from '@/components/document/format-preserving-editor'
import { UniversalDocumentViewer } from '@/components/document/universal-document-viewer'

// В компоненте
<FormatPreservingEditor
    document={document}
    onContentChange={handleChange}
    onSave={handleSave}
/>

<UniversalDocumentViewer
    document={document}
    onEdit={handleEdit}
/>
```

### Автоматическое определение типа документа

Система автоматически определяет тип файла и использует соответствующий просмотрщик:

- **PDF** → PDFViewer
- **Word (.doc/.docx)** → WordViewer  
- **Excel (.xls/.xlsx)** → ExcelViewer
- **PowerPoint (.ppt/.pptx)** → PowerPointViewer
- **Текстовые файлы** → Текстовый просмотр

### Режимы просмотра

1. **Оригинал** - отображение в родном формате файла
2. **Форматированный** - HTML версия с сохранением стилей
3. **Текст** - чистый текст без форматирования

## Преимущества новой системы

### 1. Сохранение оригинального форматирования
- Документы отображаются точно так, как они были созданы
- Сохраняются все стили, отступы, таблицы и изображения
- Нет потери качества при конвертации

### 2. Лучший пользовательский опыт
- Интуитивные элементы управления
- Масштабирование и навигация
- Полноэкранный режим для удобного просмотра

### 3. Профессиональное редактирование
- Monaco Editor - тот же редактор, что используется в VS Code
- Поддержка различных языков программирования
- Продвинутые функции поиска и замены

### 4. Универсальность
- Один компонент для всех типов документов
- Автоматическое переключение между просмотрщиками
- Единообразный интерфейс

## Миграция с старой системы

### 1. Обновите импорты
Замените все импорты старых компонентов на новые.

### 2. Обновите пропсы
- `RichEditor` → `FormatPreservingEditor`
- `initialContent` → `document.content`
- Добавьте проп `document`

### 3. Удалите старые компоненты
После миграции можно удалить:
- `components/document/rich-editor.tsx`
- `components/document/rich-editor.css`
- `components/document/document-editor.tsx`
- `components/document/formatted-document-viewer.tsx`

## Настройка и кастомизация

### Изменение тем Monaco Editor
```tsx
// В FormatPreservingEditor
options={{
    theme: 'vs-dark', // или 'vs-light', 'hc-black'
    // другие настройки...
}}
```

### Настройка PDF просмотрщика
```tsx
// В PDFViewer
<Page
    pageNumber={pageNumber}
    scale={scale}
    rotate={rotation}
    renderTextLayer={true}
    renderAnnotationLayer={true}
/>
```

### Кастомизация Word просмотрщика
```tsx
// В WordViewer
await renderAsync(arrayBuffer, containerRef.current, containerRef.current, {
    className: 'docx-viewer',
    inWrapper: true,
    breakPages: true,
    // другие опции...
})
```

## Устранение проблем

### Ошибка загрузки PDF
- Убедитесь, что `react-pdf` установлен
- Проверьте, что PDF файл не поврежден
- Проверьте CORS настройки для загрузки файлов

### Проблемы с Word документами
- Убедитесь, что `docx-preview` установлен
- Проверьте формат файла (.docx предпочтительнее .doc)
- Убедитесь, что файл не защищен паролем

### Ошибки Monaco Editor
- Проверьте, что `@monaco-editor/react` установлен
- Убедитесь, что компонент рендерится только на клиенте (SSR: false)
- Проверьте консоль браузера на ошибки JavaScript

## Производительность

### Оптимизация загрузки
- Компоненты загружаются динамически для избежания SSR проблем
- Большие файлы обрабатываются асинхронно
- Кэширование загруженных документов

### Рекомендации
- Для больших документов (>10MB) используйте прогрессивную загрузку
- Кэшируйте часто используемые документы
- Используйте Web Workers для тяжелых операций парсинга

## Будущие улучшения

### Планируемые функции
- Поддержка большего количества форматов (RTF, ODT, Pages)
- Коллаборативное редактирование
- Версионирование документов
- Расширенные аннотации
- Экспорт в различные форматы

### Интеграции
- Google Docs API
- Microsoft Office Online
- Dropbox Paper
- Notion API

## Заключение

Новая система просмотра и редактирования документов KelBetty обеспечивает профессиональный опыт работы с документами, сохраняя их оригинальное форматирование и предоставляя мощные инструменты для редактирования. Система легко расширяется и может быть адаптирована под конкретные потребности проекта.
